<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥veis Bonafe - Cat√°logo e Pre√ßos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>üè† M√≥veis Bonafe</h1>
                <p>Sistema de Cat√°logo e Pre√ßos</p>
            </div>
            <div class="content">
                <div class="loading">
                    <p>üîÑ Carregando sistema...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
// Sistema MoveisBonafe - Vers√£o GitHub Pages com Promo√ß√µes
let systemData = {
  products: [],
  categories: [],
  promotions: [],
  users: [
    { id: '1', username: 'admin', password: 'admin123', role: 'admin', name: 'Administrador' },
    { id: '2', username: 'Loja', password: 'moveisbonafe', role: 'client', name: 'Cliente Loja' }
  ],
  currentUser: null,
  syncData: {
    lastUpdate: new Date().toISOString(),
    version: '2.0',
    buildTimestamp: Date.now()
  }
};

// Supabase Configuration
let supabaseClient = null;
const SUPABASE_URL = 'https://uajegjbcvhwzsfunlhkt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhamVnamJjdmh3enNmdW5saGt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMDM4NTAsImV4cCI6MjA2MzY3OTg1MH0.Ck3-rIHdnBSFxlDiTdlQBOQGM8Gzm8PQVwE6pA8cKcI';

class SupabaseClient {
  constructor(url, key) {
    this.url = url;
    this.key = key;
    this.headers = {
      'apikey': key,
      'Authorization': `Bearer ${key}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    };
  }

  async query(table, query = '') {
    try {
      const url = `${this.url}/rest/v1/${table}${query}`;
      const response = await fetch(url, {
        method: 'GET',
        headers: this.headers
      });
      return await response.json();
    } catch (error) {
      console.error(`Erro ao consultar ${table}:`, error);
      return [];
    }
  }

  async insert(table, data) {
    try {
      const response = await fetch(`${this.url}/rest/v1/${table}`, {
        method: 'POST',
        headers: this.headers,
        body: JSON.stringify(data)
      });
      return response.ok;
    } catch (error) {
      console.error(`Erro ao inserir em ${table}:`, error);
      return false;
    }
  }

  async update(table, id, data) {
    try {
      const response = await fetch(`${this.url}/rest/v1/${table}?id=eq.${id}`, {
        method: 'PATCH',
        headers: this.headers,
        body: JSON.stringify(data)
      });
      return response.ok;
    } catch (error) {
      console.error(`Erro ao atualizar ${table}:`, error);
      return false;
    }
  }

  async delete(table, id) {
    try {
      const response = await fetch(`${this.url}/rest/v1/${table}?id=eq.${id}`, {
        method: 'DELETE',
        headers: this.headers
      });
      return response.ok;
    } catch (error) {
      console.error(`Erro ao deletar de ${table}:`, error);
      return false;
    }
  }
}

// Initialize Supabase
if (SUPABASE_URL && SUPABASE_KEY) {
  supabaseClient = new SupabaseClient(SUPABASE_URL, SUPABASE_KEY);
  console.log('‚úÖ Supabase configurado para GitHub Pages');
}

// Data Management Functions
async function loadSystemData() {
  try {
    if (supabaseClient) {
      console.log('üîÑ Carregando dados do Supabase...');
      
      const [products, categories, promotions] = await Promise.all([
        supabaseClient.query('products'),
        supabaseClient.query('categories'), 
        supabaseClient.query('promotions')
      ]);

      if (products && products.length > 0) {
        systemData.products = products.map(p => ({
          ...p,
          id: p.id.toString(),
          images: Array.isArray(p.images) ? p.images : []
        }));
      }

      if (categories && categories.length > 0) {
        systemData.categories = categories.map(c => ({
          ...c,
          id: c.id.toString()
        }));
      }

      if (promotions && promotions.length > 0) {
        systemData.promotions = promotions.map(p => ({
          ...p,
          id: p.id.toString()
        }));
      }

      console.log('‚úÖ Dados carregados do Supabase:', {
        produtos: systemData.products.length,
        categorias: systemData.categories.length,
        promocoes: systemData.promotions.length
      });
    } else {
      console.log('‚ö†Ô∏è Carregando dados do localStorage (fallback)');
      
      const stored = localStorage.getItem('moveisbonafe_data');
      if (stored) {
        const data = JSON.parse(stored);
        systemData = { ...systemData, ...data };
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao carregar dados:', error);
  }
}

async function saveSystemData() {
  try {
    localStorage.setItem('moveisbonafe_data', JSON.stringify(systemData));
    console.log('‚úÖ Dados salvos localmente');
    
    if (supabaseClient) {
      // Sync with Supabase would go here if needed
      console.log('üì° Dados sincronizados com Supabase');
    }
  } catch (error) {
    console.error('‚ùå Erro ao salvar dados:', error);
  }
}

// Authentication
async function tryLogin(username, password) {
  const user = systemData.users.find(u => u.username === username && u.password === password);
  if (user) {
    systemData.currentUser = user;
    await saveSystemData();
    console.log('‚úÖ Login realizado:', user.name);
    renderApp();
    return true;
  }
  return false;
}

function logout() {
  systemData.currentUser = null;
  saveSystemData();
  renderApp();
}

// Promotions Functions
function renderPromotionsTab() {
  const promotions = systemData.promotions || [];
  
  const promotionsHtml = promotions.map(promotion => `
    <tr>
      <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
        <div style="padding: 0.5rem 1rem; color: white; border-radius: 0.375rem; text-align: center; background: ${promotion.cor}; min-width: 200px;">
          <div style="font-weight: 600; font-size: 0.9rem;">${promotion.texto}</div>
          <div style="font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.9;">${promotion.descricao}</div>
        </div>
      </td>
      <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${promotion.texto || ''}</td>
      <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${promotion.descricao || ''}</td>
      <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
        <span style="padding: 0.25rem 0.5rem; background: ${promotion.ativo ? '#10b981' : '#ef4444'}; color: white; border-radius: 0.25rem; font-size: 0.75rem;">
          ${promotion.ativo ? 'Ativa' : 'Inativa'}
        </span>
      </td>
      <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; gap: 0.5rem;">
          <button onclick="showPromotionModal('${promotion.id}')" style="padding: 0.25rem 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
            Editar
          </button>
          <button onclick="deletePromotion('${promotion.id}')" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
            Excluir
          </button>
        </div>
      </td>
    </tr>
  `).join('');

  return `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;">üéØ Gerenciar Promo√ß√µes</h2>
      <button onclick="showPromotionModal()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
        + Nova Promo√ß√£o
      </button>
    </div>
    
    <div style="background: white; border-radius: 0.5rem; padding: 2rem; border: 1px solid #e5e7eb; margin-bottom: 2rem;">
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f9fafb;">
            <tr>
              <th style="padding: 1rem; text-align: left; font-weight: 600; color: #1e293b;">Preview</th>
              <th style="padding: 1rem; text-align: left; font-weight: 600; color: #1e293b;">Texto</th>
              <th style="padding: 1rem; text-align: left; font-weight: 600; color: #1e293b;">Descri√ß√£o</th>
              <th style="padding: 1rem; text-align: left; font-weight: 600; color: #1e293b;">Status</th>
              <th style="padding: 1rem; text-align: left; font-weight: 600; color: #1e293b;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${promotionsHtml || '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #6b7280;">Nenhuma promo√ß√£o cadastrada</td></tr>'}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function showPromotionModal(promotionId = null) {
  const promotion = promotionId ? systemData.promotions.find(p => p.id === promotionId) : null;
  const isEdit = !!promotion;
  
  const modalHtml = `
    <div id="promotion-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 1rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
          <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">üéØ ${isEdit ? 'Editar' : 'Nova'} Promo√ß√£o</h3>
        </div>
        
        <form id="promotion-form" style="padding: 1.5rem;">
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Texto da Promo√ß√£o *</label>
            <input type="text" id="promotion-texto" value="${promotion?.texto || ''}" placeholder="Ex: Desconto Especial de 20%!" 
                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" required>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Descri√ß√£o</label>
            <textarea id="promotion-descricao" placeholder="Ex: V√°lido at√© o final do m√™s" rows="3"
                      style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; resize: vertical;">${promotion?.descricao || ''}</textarea>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">üé® Cor de Fundo</label>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
              ${['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280', '#1f2937'].map(color => `
                <button type="button" onclick="selectPromotionColor('${color}')" 
                        style="width: 40px; height: 40px; border-radius: 0.5rem; border: 2px solid ${promotion?.cor === color ? '#374151' : '#e5e7eb'}; background: ${color}; cursor: pointer;"></button>
              `).join('')}
            </div>
            <input type="color" id="promotion-cor" value="${promotion?.cor || '#ef4444'}" 
                   style="width: 50px; height: 40px; border: 1px solid #d1d5db; border-radius: 0.375rem;">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Preview</label>
            <div id="promotion-preview" style="padding: 1rem; border-radius: 0.5rem; text-align: center; color: white; font-weight: 500; background: ${promotion?.cor || '#ef4444'};">
              ${promotion?.texto || 'Texto da promo√ß√£o aparecer√° aqui'}
            </div>
          </div>
          
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="promotion-ativo" ${promotion?.ativo ? 'checked' : ''} 
                     style="margin-right: 0.5rem;">
              <span style="font-weight: 500; color: #92400e;">‚≠ê Ativar esta promo√ß√£o</span>
            </label>
            <p style="margin: 0.5rem 0 0; font-size: 0.875rem; color: #92400e;">
              <strong>‚ÑπÔ∏è Importante:</strong> Apenas uma promo√ß√£o pode estar ativa por vez.
            </p>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button type="submit" style="flex: 1; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
              ${isEdit ? 'Atualizar' : 'Criar'} Promo√ß√£o
            </button>
            <button type="button" onclick="closePromotionModal()" style="flex: 1; padding: 0.75rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Event listeners
  document.getElementById('promotion-form').addEventListener('submit', (e) => {
    e.preventDefault();
    savePromotion(promotionId);
  });
  
  document.getElementById('promotion-texto').addEventListener('input', updatePromotionPreview);
  document.getElementById('promotion-cor').addEventListener('input', updatePromotionPreview);
  
  updatePromotionPreview();
}

function selectPromotionColor(color) {
  document.getElementById('promotion-cor').value = color;
  updatePromotionPreview();
}

function updatePromotionPreview() {
  const texto = document.getElementById('promotion-texto').value || 'Texto da promo√ß√£o aparecer√° aqui';
  const cor = document.getElementById('promotion-cor').value;
  const preview = document.getElementById('promotion-preview');
  
  preview.textContent = texto;
  preview.style.background = cor;
}

function closePromotionModal() {
  const modal = document.getElementById('promotion-modal');
  if (modal) {
    modal.remove();
  }
}

async function savePromotion(promotionId = null) {
  const texto = document.getElementById('promotion-texto').value.trim();
  const descricao = document.getElementById('promotion-descricao').value.trim();
  const cor = document.getElementById('promotion-cor').value;
  const ativo = document.getElementById('promotion-ativo').checked;
  
  if (!texto) {
    alert('Por favor, preencha o texto da promo√ß√£o.');
    return;
  }
  
  const promotionData = {
    texto,
    descricao,
    cor,
    ativo
  };
  
  try {
    if (promotionId) {
      await updatePromotion(promotionId, promotionData);
    } else {
      await createPromotion(promotionData);
    }
    
    closePromotionModal();
    renderApp();
  } catch (error) {
    console.error('Erro ao salvar promo√ß√£o:', error);
    alert('Erro ao salvar promo√ß√£o. Tente novamente.');
  }
}

async function createPromotion(promotionData) {
  const id = Date.now().toString();
  const newPromotion = {
    id,
    ...promotionData,
    createdAt: new Date().toISOString()
  };
  
  // Se a nova promo√ß√£o est√° ativa, desativar todas as outras
  if (promotionData.ativo) {
    systemData.promotions = systemData.promotions.map(p => ({ ...p, ativo: false }));
  }
  
  systemData.promotions = systemData.promotions || [];
  systemData.promotions.push(newPromotion);
  
  await saveSystemData();
  console.log('‚úÖ Promo√ß√£o criada:', newPromotion);
}

async function updatePromotion(id, promotionData) {
  const index = systemData.promotions.findIndex(p => p.id === id);
  if (index === -1) {
    throw new Error('Promo√ß√£o n√£o encontrada');
  }
  
  // Se a promo√ß√£o est√° sendo ativada, desativar todas as outras
  if (promotionData.ativo) {
    systemData.promotions = systemData.promotions.map(p => ({ ...p, ativo: false }));
  }
  
  systemData.promotions[index] = { ...systemData.promotions[index], ...promotionData };
  
  await saveSystemData();
  console.log('‚úÖ Promo√ß√£o atualizada:', systemData.promotions[index]);
}

async function deletePromotion(id) {
  const promotion = systemData.promotions.find(p => p.id === id);
  if (!promotion) return;
  
  if (confirm(`Tem certeza que deseja excluir a promo√ß√£o "${promotion.texto}"?`)) {
    systemData.promotions = systemData.promotions.filter(p => p.id !== id);
    await saveSystemData();
    renderApp();
    console.log('‚úÖ Promo√ß√£o exclu√≠da:', id);
  }
}

// Basic Rendering Functions
function renderApp() {
  const container = document.querySelector('.content');
  
  if (!systemData.currentUser) {
    container.innerHTML = renderLoginForm();
    return;
  }
  
  if (systemData.currentUser.role === 'admin') {
    container.innerHTML = renderAdminPanel();
  } else {
    container.innerHTML = renderCatalog();
  }
}

function renderLoginForm() {
  return `
    <div style="max-width: 400px; margin: 0 auto; text-align: center;">
      <h2 style="margin-bottom: 2rem;">üîê Login</h2>
      <form id="login-form">
        <div style="margin-bottom: 1rem;">
          <input type="text" id="username" placeholder="Usu√°rio" required
                 style="width: 100%; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
        </div>
        <div style="margin-bottom: 1rem;">
          <input type="password" id="password" placeholder="Senha" required
                 style="width: 100%; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
        </div>
        <button type="submit" style="width: 100%; padding: 1rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
          Entrar
        </button>
      </form>
      <div id="login-error" style="margin-top: 1rem;"></div>
    </div>
  `;
}

function renderAdminPanel() {
  return `
    <div style="margin-bottom: 2rem;">
      <h2>üè† Painel Administrativo</h2>
      <div style="display: flex; gap: 1rem; margin: 1rem 0;">
        <button onclick="renderTab('promotions')" style="padding: 0.5rem 1rem; background: #8b5cf6; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
          üéØ Promo√ß√µes
        </button>
        <button onclick="logout()" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
          Sair
        </button>
      </div>
    </div>
    <div id="admin-content">
      ${renderPromotionsTab()}
    </div>
  `;
}

function renderTab(tabName) {
  const content = document.getElementById('admin-content');
  if (tabName === 'promotions') {
    content.innerHTML = renderPromotionsTab();
  }
}

function renderCatalog() {
  const activePromotion = systemData.promotions.find(p => p.ativo);
  
  return `
    <div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2>üè† Cat√°logo M√≥veis Bonafe</h2>
        <button onclick="logout()" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
          Sair
        </button>
      </div>
      
      ${activePromotion ? `
        <div style="margin-bottom: 2rem; padding: 1rem; background: ${activePromotion.cor}; color: white; border-radius: 0.5rem; text-align: center;">
          <div style="font-weight: 600; font-size: 1.25rem;">${activePromotion.texto}</div>
          ${activePromotion.descricao ? `<div style="margin-top: 0.5rem; opacity: 0.9;">${activePromotion.descricao}</div>` : ''}
        </div>
      ` : ''}
      
      <p style="text-align: center; color: #666; margin: 2rem 0;">
        Sistema funcionando! As promo√ß√µes ativas aparecer√£o aqui.
      </p>
    </div>
  `;
}

// Initialize the application
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Inicializando sistema MoveisBonafe...');
  
  await loadSystemData();
  
  // Event delegation for login form
  document.addEventListener('submit', async (e) => {
    if (e.target.id === 'login-form') {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (!username || !password) {
        errorDiv.innerHTML = '<div style="color: #dc2626; font-size: 0.875rem;">Por favor, preencha todos os campos.</div>';
        return;
      }
      
      errorDiv.innerHTML = '<div style="color: #3b82f6; font-size: 0.875rem;">Verificando credenciais...</div>';
      
      const success = await tryLogin(username, password);
      if (!success) {
        errorDiv.innerHTML = '<div style="color: #dc2626; font-size: 0.875rem;">Usu√°rio ou senha incorretos.</div>';
      }
    }
  });
  
  renderApp();
  console.log('‚úÖ Sistema MoveisBonafe carregado com sucesso!');
});
    </script>
</body>
</html>